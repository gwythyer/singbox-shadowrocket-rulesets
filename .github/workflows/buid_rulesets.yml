name: Build rule-sets (srs + list)

on:
  push:
    paths:
      - "rulesets/source/direct/*.txt"
      - "rulesets/source/proxy/*.txt"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download sing-box
        run: |
          set -euo pipefail
          VERSION=1.12.17
          wget -q https://github.com/SagerNet/sing-box/releases/download/v$VERSION/sing-box-$VERSION-linux-amd64.tar.gz
          tar -xzf sing-box-$VERSION-linux-amd64.tar.gz
          mv sing-box-$VERSION-linux-amd64/sing-box ./sing-box
          chmod +x ./sing-box
          ./sing-box version

      - name: Generate Shadowrocket .list (fail on empty)
        run: |
          set -euo pipefail
          mkdir -p rulesets/shadowrocket/direct rulesets/shadowrocket/proxy
          shopt -s nullglob

          for dir in direct proxy; do
            for f in rulesets/source/${dir}/*.txt; do
              # Require at least one non-empty, non-comment line
              if ! grep -qE '^[^#[:space:]]' "$f"; then
                echo "ERROR: Empty ruleset source file (or comments/whitespace only): $f"
                exit 1
              fi

              base=$(basename "$f" .txt)
              name="${dir}-${base}"
              out="rulesets/shadowrocket/${dir}/${name}.list"

              echo "# ${name}" > "$out"
              grep -E '^[^#[:space:]]' "$f" | sed 's/^/DOMAIN-SUFFIX,/' >> "$out"
            done
          done

      - name: Generate sing-box JSON (fail on empty)
        run: |
          set -euo pipefail
          mkdir -p rulesets/singbox/direct rulesets/singbox/proxy
          shopt -s nullglob

          for dir in direct proxy; do
            for f in rulesets/source/${dir}/*.txt; do
              # Require at least one non-empty, non-comment line
              if ! grep -qE '^[^#[:space:]]' "$f"; then
                echo "ERROR: Empty ruleset source file (or comments/whitespace only): $f"
                exit 1
              fi

              base=$(basename "$f" .txt)
              name="${dir}-${base}"
              json="rulesets/singbox/${dir}/${name}.json"

              {
                echo '{ "version": 1, "rules": [ { "domain_suffix": ['
                grep -E '^[^#[:space:]]' "$f" | sed 's/.*/"&",/' | sed '$ s/,$//'
                echo '] } ] }'
              } > "$json"
            done
          done

      - name: Validate sing-box JSON
        run: |
          set -euo pipefail
          shopt -s nullglob
          for f in rulesets/singbox/direct/*.json rulesets/singbox/proxy/*.json; do
            jq empty "$f"
          done

      - name: Compile SRS
        run: |
          set -euo pipefail
          mkdir -p build/direct build/proxy
          shopt -s nullglob

          for dir in direct proxy; do
            for f in rulesets/singbox/${dir}/*.json; do
              echo "Compiling $f"
              ./sing-box rule-set compile "$f"

              srs="${f%.json}.srs"
              if [ ! -s "$srs" ]; then
                echo "ERROR: $srs is empty or missing"
                exit 1
              fi

              mv "$srs" "build/${dir}/"
            done
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto build ${{ github.run_number }}
          body_path: RELEASE.md
          files: |
            build/direct/direct-*.srs
            build/proxy/proxy-*.srs
            rulesets/shadowrocket/direct/direct-*.list
            rulesets/shadowrocket/proxy/proxy-*.list
            Nekoray/*.json
            Shadowrocket/*.conf
